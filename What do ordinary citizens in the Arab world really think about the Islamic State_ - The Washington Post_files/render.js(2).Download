(function(){var wp_data=window.wp_meta_data;var article=null;var host="https://contextual-linking-public-prod.washpost.nile.works/api/v1/";var locale=document.location.toString();if(locale.match(/wpprivate/))host=host.replace(/prod/,"test");var links={init:function(){var self=this;if(wp_data&&wp_data.contextualLinking&&wp_data.contextualLinking.matches&&wp_data.contextualLinking.matches.result)self.processAll(wp_data.contextualLinking.matches.result.matches)},processAll:function(data){var self=this;
article=data;var links=[];var results=article||[];if(results)for(var key in results)if(results.hasOwnProperty(key))links.push(results[key]);for(var i=0;i<links.length;i++)try{if(links[i].approval_status&&(links[i].approval_status=="pending"||links[i].approval_status=="approved")&&links[i].deleted_at===null)self.processOne(links[i])}catch(e){}},processOne:function(link){var self=this;var found=false;var articleLinks=document.querySelector("article").getElementsByTagName("a");for(var i=0;i<articleLinks.length;i++){var href1=
(articleLinks[i].href||"").replace(/[?#].*/,"");var href2=link.concept__concept_url.replace(/[?#].*/,"");if(href1==href2)found=true}if(!found){var articlePars=document.querySelector("article").getElementsByTagName("p");for(var p=0;p<articlePars.length;p++)self.addLink(articlePars[p],link)}},addLink:function(elem,link){var self=this;var val;if(link.found)return true;for(var i=0;i<elem.childNodes.length;i++){var node=elem.childNodes[i];if(node.nodeType==Node.TEXT_NODE){if(self.isMatch(node,link)){self.replaceTextWithLink(node,
link);link.found=true}}else if(node.nodeType==Node.ELEMENT_NODE)if(node.nodeName.toLowerCase()!="a"){val=self.addLink(node,link);if(val)return true}else;}},replaceTextWithLink:function(textNode,link){var match=this.getRegex(link).exec(textNode.textContent);if(match[1].length>0)textNode=textNode.splitText(match[1].length);if(textNode.textContent.length==link.matched_keyword.length);else textNode.splitText(link.matched_keyword.length);var newNode=document.createElement("a");newNode.setAttribute("href",
link.concept__concept_url+"?tid\x3da_cntx");newNode.setAttribute("target","_blank");newNode.textContent=textNode.textContent;var parent=textNode.parentNode;parent.replaceChild(newNode,textNode);this.serveLink(link);this.trackClick(newNode,link)},isMatch:function(node,link){var t1=node.textContent.replace(/[^a-z]/gi,"").trim();var t2=link.matched_text_block.replace(/[^a-z]/gi,"").trim();if(t1.substr(0,50)==t2.substr(0,50))return true;return false},getRegex:function(link){return new RegExp("(.*?)("+
link.matched_keyword+")(.*)","i")},trackClick:function(elem,link){elem.addEventListener("click",function(){var cReq=new XMLHttpRequest;cReq.open("POST",host+"matches/"+link.id+"/clicked/",true);cReq.responseType="json";cReq.setRequestHeader("Arc-Organization","washpost");cReq.send()},false)},serveLink:function(link){var sReq=new XMLHttpRequest;sReq.open("POST",host+"matches/"+link.id+"/served/",true);sReq.responseType="json";sReq.setRequestHeader("Arc-Organization","washpost");sReq.send()}};if(wp_pb.StaticMethods.isPageHydrated())links.init();
var shambleEvent=window.__e;shambleEvent.push(["shamble",function(){links.init()}]);return links})();