(function($){var logger=!!window.TWP&&!!TWP.Tools&&!!TWP.Tools.logger?new TWP.Tools.logger("pb-f-page-newsletter-inLine"):window.console,__e=window.__e||[];var userId=document.cookie.match(/wapo_login_id=([^;]+)/)?RegExp.$1:"",userSecureId=document.cookie.match(/wapo_secure_login_id=([^;]+)/)?RegExp.$1:"",wp_pb=window.wp_pb||{},env=wp_pb.environment||"production";function NewsletterData(objValue){var obj=objValue||{};this.id=obj.id||"";this.name=obj.name||"";this.headline=obj.headline||"";this.blurb=
obj.blurb||""}function Newsletter($root){var $article=$("#article-body article"),isHomepage=$root.find(".newsletter-inline-unit").hasClass("homepage"),codedNewsletter=$root.find(".newsletter-inline-unit").hasClass("codedNewsletter"),keywordExists=$root.find(".newsletter-inline-unit").hasClass("keywordExists"),showdefault=$root.find(".hidden-data .show-default").text()=="true"?true:false,newsletter={value:new NewsletterData};if($root.find(".newsletter-inline-unit").hasClass("rightRail"))$root.addClass("rightRail");
if(isHomepage)$root.addClass("homepage");this.init=function(){var showUnit=true,newsletterpositioned=true;if(codedNewsletter&&keywordExists==false&&showdefault==false&&isHomepage==false)showUnit=false;if(window.location.href.indexOf("/pr/")>-1||window.location.href.indexOf("/terms-of-service/")>-1||window.location.href.indexOf("/terms-of-sale-for-digital-products/")>-1||window.location.href.indexOf("/privacy-policy/")>-1)showUnit=false;if(showUnit){if(isHomepage==false)newsletterpositioned=positionNewsletter();
if(newsletterpositioned!==false)if($root.find(".pb-subscribe-newsletter").hasClass("showSubscription")&&wp_pb&&wp_pb.StaticMethods&&!wp_pb.StaticMethods.isSubscriber())$root.find(".pb-subscribe-newsletter").removeClass("hide");else applyDarwinTest()}else $root.remove()};function applyTestParams(variant){if(variant.is("visual")){$(".signup-module .headline-img").attr("src","http://www.washingtonpost.com/pb/resources/img/blogs/sos-yellow-lightbulb.png");$(".signup-module .img-cont").removeClass("hide");
applyDesktop("tst_visual")}else if(variant.is("oneClick"))applyMailTo("One-click sign up","Instead of typing your email address, all you have to do is hit send to start receiving Speaking of Science, our weekly email on the latest and greatest in science news.");else if(variant.is("oneClickAlt"))applyMailTo("Instant subscribe","Instead of typing your email address, all you have to do is hit send to start receiving Speaking of Science, our weekly email on the latest and greatest in the world of science.");
else{var speakingScience=$root.find(".blogname-instream").text()=="speaking-of-science";var testVariant=window.isMobile.any()==true&&userId==""&&speakingScience?"tst_defailt":"";applyDesktop(testVariant)}}function applyDesktop(variantMataData){var captchaId;var email;var resetCaptcha=function(){if(captchaId)window.grecaptcha.reset();$("#nlilrecaptchadiv").html("");captchaId=window.grecaptcha.render("nlilrecaptchadiv",{sitekey:"6Lf0DRoUAAAAAEawkoNEUKcpWx8eh_I7PRArTA9V",size:"invisible",callback:function(resp){logger.info("response key \x3d "+
window.grecaptcha.getResponse(captchaId));$("#captchaDiv .text-success").show();setTimeout(function(){$("#captchaDiv .text-success").hide();$("#captchaDiv").hide()},5E3);subscribe(email,resp,variantMataData)}})};var captchaInitialized=0;$root.find(".sign-up-input").click(function(){if(!captchaInitialized){captchaInitialized=1;resetCaptcha($(this).html())}});$root.find(".inline-newsletter-form").submit(function(e){e.preventDefault();var subscribeEmail=$root.find(".sign-up-input").val(),re=/[A-Z0-9._%+-]+@[A-Z0-9.-]+.[A-Z]{2,4}/gim;
if(subscribeEmail==""||!re.test(subscribeEmail))showError("Please enter a valid email address");else{hideError();email=subscribeEmail;window.grecaptcha.execute(captchaId)}});$root.find(".open-sign-up-btn").click(function(){if(typeof grecaptcha==="undefined")$.ajax({url:"https://www.google.com/recaptcha/api.js",dataType:"script",cache:true,success:function(){var findCaptcha=setInterval(function(){if(typeof grecaptcha!=="undefined")clearInterval(findCaptcha)},50)},error:function(){}});if(userId!=="")subscribe();
else{$root.find(".open-sign-up, .title-container").addClass("hide");$root.find(".input-container, .submit-sign-up").removeClass("hide")}})}function applyMailTo(buttonTxt,bodyMessage){var email="newslettersignup@washpost.com";var subject="Hit send to start receiving the Speaking of Science newsletter";var href="mailto:"+email+"?subject\x3d"+subject+"\x26body\x3d"+bodyMessage;$(".signup-module .headline-img").attr("src","http://www.washingtonpost.com/pb/resources/img/blogs/sos-yellow-lightbulb.png");
$(".signup-module .img-cont").removeClass("hide");var $link=$("\x3ca\x3e",{href:"#",html:buttonTxt,"class":"mailToLink"});$(".sign-up-btn.open-sign-up-btn").html($link);$(".sign-up-btn.open-sign-up-btn .mailToLink").click(function(){s.sendDataToOmniture("Newsletter In Line Unit","event80",trackProps("nl_instream_simple_"+newsletter.value.name.toLowerCase().split(" ").join("-")+"_1"),{wait:true});window.location.href=href})}var applyDarwinTest=function(){var _dw=window._dw||[];_dw.push(["global","ready",
function(api){var variant=api.get("article-oneClickNL");applyNewsletterData().done(function(){applyTestParams(variant)})}])};function showConfirmation(){$root.find(".signup-module").addClass("hide");$root.find(".success-confirmation, .title-container").removeClass("hide")}function showError(message){$root.find(".error").text(message).removeClass("hide")}function hideError(){$root.find(".error").addClass("hide")}function getPageData(){var section=$root.find(".section-instream").text(),subSection=$root.find(".subsection-instream").text(),
blog=$root.find(".blogname-instream").text(),data={};if(userId!=="")data.washPostId=userId;if(blog)data.blog=blog;if(subSection)data.subSection=subSection;if(section)data.section=section;return data}function getInLineNewsletter(){var data=getPageData(),url="https://recommendation-newsletter.wpdigital.net/Newsletter/api/newsletter";return $.ajax({type:"POST",dataType:"json",contentType:"application/json",url:url,data:JSON.stringify(data)})}function subscribe(email,recaptchaToken,testVariantMetadata){var data,
url;if(userId!==""){if(env=="production")url="https://subscribe.washingtonpost.com/person/newsletter/subscribe";else url="https://subscribe.digitalink.com/person/newsletter/subscribe";data={wapoLoginID:userId,wapoSecureID:userSecureId,userAgent:navigator.userAgent,newsletterName:newsletter.value.id,metadata:[{name:"nl_start_method",value:"S"},{name:"nl_start_location",value:"IS"}]};if(recaptchaToken)data["recaptchaResponse"]=recaptchaToken}else if(email){if(env=="production")url="https://subscribe.washingtonpost.com/person/newsletter/subscribe-email";
else url="https://subscribe.digitalink.com/person/newsletter/subscribe-email";data={email:email,newsletterName:newsletter.value.id,metadata:[{name:"nl_start_method",value:"S"},{name:"nl_start_location",value:"IS"}]};if(testVariantMetadata)data.metadata.push({name:"nl_start_initiative",value:testVariantMetadata});if(recaptchaToken)data["recaptchaResponse"]=recaptchaToken}$.ajax({type:"POST",dataType:"json",contentType:"application/json",url:url,data:JSON.stringify(data),success:function(data){if(data.status==
"SUCCESS"){showConfirmation();s.sendDataToOmniture("Newsletter In Line Unit","event91",trackProps("nl_instream_simple_"+newsletter.value.name.toLowerCase().split(" ").join("-")+"_1"),{wait:true})}else showError("Error while subscribing, please try later.")},error:function(){showError("Error while subscribing, please try later.")}})}var applyNewsletterData=function(){var d=$.Deferred();if(codedNewsletter&&keywordExists||isHomepage&&codedNewsletter){$root.addClass("codedNewsletter").find(".newsletter-inline-unit").removeClass("hide");
var data={};data.headline=data.name=$root.find(".coded-nl-headline").text();data.blurb=$root.find(".coded-nl-tagline").text();data.id=$root.find(".coded-nl-id").text();newsletter.value=new NewsletterData(data);$root.find(".headline").text(newsletter.value.headline);$root.find(".tagline").text(newsletter.value.blurb);d.resolve("hardcoded")}else if(!codedNewsletter||showdefault)getInLineNewsletter().done(function(data){if(!$.isEmptyObject(data.newsletter)){newsletter.value=new NewsletterData(data.newsletter);
$root.find(".headline").text(newsletter.value.headline);$root.find(".tagline").text(newsletter.value.blurb);$root.find(".newsletter-inline-unit").removeClass("hide");d.resolve("gotnewsletter")}else{$root.addClass("hide");d.resolve("hidden")}}).fail(function(){$root.addClass("hide");d.reject()});return d.promise()};function positionNewsletter(){var position=$root.find(".newsletter-position").text();var paragraph;if(position=="after3th"){if($article.length>0&&$article.children("p").length<3){$root.addClass("hide");
return false}var index=2;for(var i=0;i<=index;i++){var p=$article.find(" \x3e p")[i];if(p&&$(p).text().trim()=="")index++}paragraph=$article.find(" \x3e p")[index];$(paragraph).after($root.addClass("injected-by-front-end"));return true}else if(position=="liveblog3rd"){if($(".liveblog-stream").length>0&&$(".liveblog-post").length<3){$root.addClass("hide");return false}var post=$(".liveblog-stream").find(".liveblog-post")[2];$(post).after($root.addClass("injected-by-front-end"));return true}else{if($article.length>
0&&$article.children("p").length<8){$root.addClass("hide");return false}var paragraphs=$article.find(' \x3e p[class!\x3d"interstitial-link"]');paragraphs=jQuery.grep(paragraphs,function(elem){return $(elem).text().trim()!=""});paragraph=paragraphs[paragraphs.length-3];$(paragraph).before($root.addClass("injected-by-front-end"));var prevContent=$root.prev(),prevprevContent=$root.prev().prev(),prevprevprevContent=$root.prev().prev().prev();if($(prevContent).hasClass("inline-photo-left")||$(prevContent).hasClass("inline-photo-right"))$(prevContent).before($root.addClass("injected-by-front-end"));
if($(prevprevContent).hasClass("inline-photo-left")||$(prevprevContent).hasClass("inline-photo-right"))$(prevprevContent).before($root.addClass("injected-by-front-end"));if($(prevprevprevContent).hasClass("inline-photo-left")||$(prevprevprevContent).hasClass("inline-photo-right")){$(prevprevprevContent).before($root.addClass("injected-by-front-end"));$root.addClass("injected-by-front-end")}return true}}function trackProps(enhancedKey){var subsection=window.wp_subsection||"";var contentType=window.wp_content_type||
"";var channel=window.wp_channel||"";var props={eVar2:"wp - "+subsection,prop2:"wp - "+subsection,prop3:contentType,eVar17:contentType,channel:channel};props.eVar26=enhancedKey;return props}}var lifecycle={init:function(){$(".pb-f-page-newsletter-inLine").each(function(){var nl=new Newsletter($(this));nl.init()})}};if(wp_pb.StaticMethods.isPageHydrated())lifecycle.init();__e.push(["shamble",function(){lifecycle.init()}])})(jQuery);