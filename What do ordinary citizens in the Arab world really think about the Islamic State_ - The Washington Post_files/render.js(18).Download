(function($,window){var env=wp_pb.environment||"production";var apiURL,subscribeURL,unSubscribeURL,recentNotificationsURL;var pushNotifToken="push_notification_token";var Notifications="push_notifications";var sessionCount="push_notif_session_count";var lastModified="push_notif_lastModified";var subscribedToMMP="push_notif_subscribedMMP";var reg;var logger=new TWP.Tools.logger("dn");var Push={init:function(){var width=window.innerWidth>0?window.innerWidth:screen.width,is_chrome=navigator.userAgent.indexOf("Chrome")>
-1;if(env=="production")apiURL="https://devicereg.washingtonpost.com/";else apiURL="https://device-reg-staging.wpdigital.net/";subscribeURL=apiURL+"pushv2/register/breaking_news/DESKTOP_ALERTS/DESKTOP_CHROME?deviceToken\x3d";unSubscribeURL=apiURL+"pushv2/unregister/breaking_news/DESKTOP_ALERTS?deviceToken\x3d";recentNotificationsURL=apiURL+"pushv2/messages/recent?pushApp\x3dDESKTOP_ALERTS\x26days\x3d1";if(env=="production")recentNotificationsURL="https://device-reg.wpdigital.net/pushv2/messages/recent?pushApp\x3dDESKTOP_ALERTS\x26days\x3d1";
$(".pb-f-page-push-notifications").addClass("hide");if(is_chrome&&width>400){if(Notification.permission==="default")$(".notif-number").html("1").removeClass("hide");Push.initServiceWorker()}},initServiceWorker:function(){if("serviceWorker"in navigator){logger.log("Service Worker is supported");navigator.serviceWorker.addEventListener("message",function(event){logger.log("Push alerts updated",event.data);Push.saveInLocalStorage(event.data)});wp_pb&&wp_pb.StaticMethods&&wp_pb.StaticMethods.registerServiceWorker().then(function(){return navigator.serviceWorker.ready}).then(function(serviceWorkerRegistration){reg=
serviceWorkerRegistration;logger.log("Service Worker is ready :^)",reg);Push.requestPermission();Push.initNotifications()})["catch"](function(error){logger.log("Service Worker Error :^(",error)})}},getSubscription:function(callback){reg.pushManager.getSubscription().then(function(pushSubscription){if(pushSubscription==null)reg.pushManager.subscribe({userVisibleOnly:true}).then(function(pushSubscription){var x=pushSubscription.endpoint.split("/");token=x[x.length-1];window.localStorage.setItem(pushNotifToken,
token);Push.subscribeMMP(pushSubscription,callback)});else{var x=pushSubscription.endpoint.split("/");var token=x[x.length-1];window.localStorage.setItem(pushNotifToken,token);if(callback)callback()}})},subscribeMMP:function(subscription,callback){var userData,token,url;userData=subscription.toJSON().keys.auth;var x=subscription.endpoint.split("/");token=x[x.length-1];url=subscribeURL+token+"\x26userData\x3d"+userData;(function _subscribeMMP(){$.get(url,function(data){if(callback)callback();if(data.status==
"Registered")window.localStorage.setItem(subscribedToMMP,true);else if(data.status=="Queued"){window.localStorage.setItem(subscribedToMMP,"Queued");setTimeout(function(){_subscribeMMP()},3E4)}}).fail(function(){window.localStorage.setItem(subscribedToMMP,false);setTimeout(function(){_subscribeMMP()},3E4)})})()},unsubscribe:function(callback){reg.pushManager.getSubscription().then(function(pushSubscription){if(pushSubscription){var x=pushSubscription.endpoint.split("/");var token=x[x.length-1];(function _unsubscribeMMP(){$.get(unSubscribeURL+
token,function(){window.localStorage.removeItem(pushNotifToken);window.localStorage.removeItem(Notifications);window.localStorage.removeItem(lastModified);window.localStorage.removeItem(subscribedToMMP);pushSubscription.unsubscribe().then(function(event){logger.log("Unsubscribed!",event);if(callback)callback()})["catch"](function(error){logger.log("Error unsubscribing",error)})}).fail(function(){setTimeout(function(){_unsubscribeMMP()},3E4);window.localStorage.removeItem(pushNotifToken);window.localStorage.removeItem(Notifications);
window.localStorage.removeItem(lastModified);window.localStorage.removeItem(subscribedToMMP);$(".notifications-container .permission-request").addClass("hide");$(".notifications-container .notification-items").addClass("hide");pushSubscription.unsubscribe().then(function(event){logger.log("Unsubscribed!",event);if(callback)callback()})["catch"](function(error){logger.log("Error unsubscribing",error)});sendToScout("count","UnSubscribeResponseError",1,["env:"+env],1)})})()}else{window.localStorage.removeItem(pushNotifToken);
window.localStorage.removeItem(Notifications);window.localStorage.removeItem(lastModified);if(callback)callback()}})},getSubscriptionToken:function(){return localStorage.getItem(pushNotifToken)},_timeSince:function(date){var currentTime=(new Date).toLocaleString("en-US",{timeZone:"America/New_York"});var seconds=Math.floor((new Date(currentTime)-date)/1E3);if(seconds<3)return"just now";if(seconds<60)return Math.floor(seconds)+" seconds ago";var interval=Math.floor(seconds/3600);if(interval==1)return interval+
" hour ago";if(interval>24)return false;if(interval>1)return interval+" hours ago";interval=Math.floor(seconds/60);if(interval==1)return interval+" minute ago";if(interval>1)return interval+" minutes ago";return Math.floor(seconds)+" seconds ago"},_appendItem:function(notifications){var $container=$(".notifications-container .notification-items .notifications-list");var seenCount=0,itemAdded=false;if(window.localStorage.getItem(subscribedToMMP)=="false"){$container.html("\x3cp class\x3d'empty-notification-txt'\x3eNotifications are not currently available.\x3c/p\x3e");
return}if(notifications&&notifications.length>0){var $list=$(document.createElement("div"));var url="";for(var i=0;i<notifications.length;i++){var data=notifications[i];var messageId=data.pushID;var time=Push._timeSince(new Date(data.datetime));if(time!==false){var $item=$(document.createElement("div"));$item.addClass("item");if(data.seen)$item.addClass("seen");else seenCount++;var $headline=$(document.createElement("a"));$headline.addClass("headline");$headline.html(data.headline);if(data.contentURL.indexOf("?")>
-1)url=data.contentURL+"\x26tidr\x3dnotifi_bell_breaking-news\x26pushid\x3d"+messageId;else url=data.contentURL+"?tidr\x3dnotifi_bell_breaking-news\x26pushid\x3d"+messageId;$headline.attr("href",url);var $tagline=$(document.createElement("p"));$tagline.addClass("tagline");$tagline.html(time);$item.append($headline);$item.append($tagline);$list.append($item);itemAdded=true}}}if(seenCount>0)$(".notif-number").html(seenCount).removeClass("hide");if(itemAdded==false)$container.html("\x3cp class\x3d'empty-notification-txt'\x3eThere are no recent notifications.\x3c/p\x3e");
else $container.html($list)},updateNotifications:function(){function performGET(){$.get(recentNotificationsURL,function(data,status,xhr){window.localStorage.setItem(lastModified,xhr.getResponseHeader("Last-Modified"));Push.saveInLocalStorage(data.DESKTOP_ALERTS)}).fail(function(){sendToScout("count","APIResponseError",1,["env:"+env],1)})}var lastModifiedData=window.localStorage.getItem(lastModified);if(lastModifiedData)$.ajax({type:"HEAD",url:recentNotificationsURL}).done(function(data,status,xhr){if(xhr.getResponseHeader("Last-Modified")!==
lastModifiedData)performGET()}).fail(function(){sendToScout("count","APIResponseError",1,["env:"+env],1)});else performGET()},saveInLocalStorage:function(notificationData){var savedData=JSON.parse(window.localStorage.getItem(Notifications));if(savedData){for(var i=0;i<notificationData.length;i++){var result=$.grep(savedData,function(e){return e.messageId==notificationData[i].messageId});if(result.length>0)notificationData[i].seen=result[0].seen}savedData=notificationData}else savedData=notificationData;
if(savedData&&savedData.length>0){window.localStorage.setItem(Notifications,JSON.stringify(savedData));Push._appendItem(savedData)}else $(".notifications-container .notifications-list").html("\x3cp class\x3d'empty-notification-txt'\x3eThere are no recent notifications.\x3c/p\x3e")},fetchNotifications:function(){var token=Push.getSubscriptionToken();if(token&&token!==""){var savedData=JSON.parse(window.localStorage.getItem(Notifications));Push.saveInLocalStorage(savedData);if(window.localStorage.getItem(subscribedToMMP)!==
"true")setTimeout(function(){reg.pushManager.getSubscription().then(function(pushSubscription){Push.subscribeMMP(pushSubscription)})},3E4)}},reqPermNativePopup:function(){setTimeout(function(){sendCustomTrackProps("notifications ask","notifi_ask")},5E3);Notification.requestPermission(function(permission){if(permission==="granted"){sendCustomTrackProps("notifications allowed","notifi_allowed");Push.getSubscription(function(){Push.fetchNotifications();Push.updateNotifications();$(".notifications-container .permission-request").addClass("hide");
$(".notify-ic").removeClass("bell-opened")})}else if(permission==="denied"){$(".notifications-container .permission-request .permission-default").addClass("hide");$(".notifications-container .permission-request .permission-denied").removeClass("hide");sendCustomTrackProps("notifications blocked","notifi_blocked")}else if(permission=="default")sendCustomTrackProps("notifications dismissed","notifi_dismissed")})},initNotifications:function(){function hideAll(scrolling){$(".notif-number, .notification-items, .permission-request").addClass("hide");
$(".notify-ic").removeClass("bell-opened");$(".notifications-list").removeClass("scrolling");if(scrolling)sendCustomTrackProps("notifications bell close scroll","notifi_bell-close-scroll");else sendCustomTrackProps("notifications bell close click","notifi_bell-close-click")}function showRequestPermission(){$(".notifications-container .permission-request").removeClass("hide");$(".notifications-container .notification-items").addClass("hide");$(".notify-ic").addClass("bell-opened")}function showNotifications(){var savedData=
JSON.parse(window.localStorage.getItem(Notifications));Push._appendItem(savedData);$(".notification-items").removeClass("hide");$(".notifications-container .permission-request").addClass("hide");$(".notify-ic").addClass("bell-opened");var h=Math.max(document.documentElement.clientHeight,window.innerHeight||0);if(h-220<$(".notifications-list").height())$(".notifications-list").addClass("scrolling");if(!$(".notif-number").hasClass("hide")){$(".notif-number").addClass("hide");if(savedData){for(var i=
0;i<savedData.length;i++)savedData[i].seen=true;window.localStorage.setItem(Notifications,JSON.stringify(savedData))}}}$(document).mouseup(function(e){var container=$(".notifications-container");if(!container.is(e.target)&&container.has(e.target).length===0&&(!$(".notification-items").hasClass("hide")||!$(".permission-request").hasClass("hide")))hideAll()});wp_pb.register("nav","finish_close",function(){if(!$(".notification-items").hasClass("hide")||!$(".permission-request").hasClass("hide"))hideAll(true)});
window.addEventListener("online",function(){var token=Push.getSubscriptionToken();if(token&&token!=="")Push.updateNotifications()});$(".notifications-container .permission-request .notify-action.yes").click(function(){if(!$.trim($(".permission-denied").html()).length){var noticeurl="/pb/api/v2/render/feature/page/push-notifications?shownotice\x3dshownotice";$.get(noticeurl,function(data){var rootEl=$(data.rendering);var permissionText=rootEl.find(".permission-denied-text");$("#nav-bar").find(".permission-denied").append(permissionText);
var permissionImage=rootEl.find(".permission-denied-img");$("#nav-bar").find(".permission-denied").append(permissionImage)})}sendCustomTrackProps("notifications turn on","notifi_bell-turnon");Push.reqPermNativePopup()});$(".notifications-container .turn-off").click(function(){sendCustomTrackProps("notifications turn off","notifi_bell-turnoff");Push.unsubscribe(function(){$(".notifications-container .permission-request").removeClass("hide");$(".notifications-container .notification-items").addClass("hide")});
return false});$(".notifications-container .notify-action.not-now").click(function(){hideAll()});$(".notify-ic").click(function(){if($(this).hasClass("bell-opened")){hideAll();return}if($(".pb-f-posttv-live-bar").height())$(".notifications-top-arrow").addClass("gear-bar");else $(".notifications-top-arrow").removeClass("gear-bar");sendCustomTrackProps("notifications bell open","notifi_bell-open");if(Notification.permission==="granted"){var token=Push.getSubscriptionToken();if(token&&token!=="")showNotifications();
else showRequestPermission()}else showRequestPermission()});if(Notification.permission==="granted")Push.fetchNotifications();var $headerNotifications=$(".pb-f-page-push-notifications .notifications-container").removeClass("hidden");$(".pb-f-page-header-v2 .sign-up-buttons").after($headerNotifications)},requestPermission:function(){if(Notification.permission==="default"){var session=window.sessionStorage.getItem(sessionCount),sessionIntVal=session?parseInt(session):0;window.sessionStorage.setItem(sessionCount,
++sessionIntVal);if(sessionIntVal%3==0)Push.reqPermNativePopup(true)}}};var sendToScout=function(type,key,value,tgs,sampleRate){sampleRate=sampleRate||1;tgs=tgs||[];var message={k:"PushNotification."+key,v:value,tags:tgs,sr:sampleRate};var xmlhttp=new XMLHttpRequest;xmlhttp.open("POST","https://pharos.arcpublishing.com/scout/"+type);xmlhttp.setRequestHeader("Content-Type","application/json;charset\x3dUTF-8");xmlhttp.send(JSON.stringify(message))};function trackProps(value){var props={pageName:window.wp_page_name,
eVar1:window.wp_page_name,prop2:window.wp_subsection,eVar2:window.wp_channel,prop3:window.wp_content_type,eVar17:window.wp_content_type};props.eVar26=value;return props}function sendCustomTrackProps(name,value){if(window.s)window.s.sendDataToOmniture(name,"event80",trackProps(value),{wait:true})}Push.init()})(jQuery,window);